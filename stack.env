# ============================================================================
# Portainer Stack Environment Variables
# ============================================================================
# This file is used by Portainer when deploying via Git repository.
# Variables here override docker-compose.prod.yml defaults.
# ============================================================================

# ----------------------------------------------------------------------------
# PostgreSQL Configuration
# ----------------------------------------------------------------------------
POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_DB=fileintel
POSTGRES_MAX_CONNECTIONS=600
POSTGRES_SHARED_BUFFERS=3GB
POSTGRES_EFFECTIVE_CACHE_SIZE=8GB
POSTGRES_WORK_MEM=32MB
POSTGRES_MEMORY_LIMIT=10G

# ----------------------------------------------------------------------------
# Redis Configuration
# ----------------------------------------------------------------------------
REDIS_MAXMEMORY=3gb
REDIS_MEMORY_LIMIT=4G

# ----------------------------------------------------------------------------
# Storage Configuration
# ----------------------------------------------------------------------------
STORAGE_POOL_SIZE=20
STORAGE_MAX_OVERFLOW=30
STORAGE_POOL_TIMEOUT=300

# ----------------------------------------------------------------------------
# API Configuration
# ----------------------------------------------------------------------------
API_PORT=8001
API_KEY=key

# ----------------------------------------------------------------------------
# LLM Provider Configuration
# ----------------------------------------------------------------------------
OPENAI_API_KEY=key
LLM_HTTP_TIMEOUT=900
LLM_MAX_RETRIES=20
LLM_RETRY_BACKOFF_MIN=2
LLM_RETRY_BACKOFF_MAX=300

# ----------------------------------------------------------------------------
# Logging Configuration
# ----------------------------------------------------------------------------
LOG_LEVEL=INFO
TRANSFORMERS_NO_ADVISORY_WARNINGS=1

# ----------------------------------------------------------------------------
# Host Paths (TrueNAS mounts)
# ----------------------------------------------------------------------------
HOST_PROMPTS_PATH=/mnt/HDDs/docker/apps/fileintel/prompts
HOST_LOGS_PATH=/mnt/HDDs/docker/apps/fileintel/logs
HOST_UPLOADS_PATH=/mnt/HDDs/docker/apps/fileintel/uploads
HOST_INPUT_PATH=/mnt/HDDs/docker/apps/fileintel/input
HOST_OUTPUT_PATH=/mnt/HDDs/docker/apps/fileintel/output
HOST_GRAPHRAG_PATH=/mnt/HDDs/docker/apps/fileintel/graphrag_index
HOST_MINERU_OUTPUTS_PATH=/mnt/HDDs/docker/apps/fileintel/mineru

# ----------------------------------------------------------------------------
# Celery Worker Configuration - Prefork
# ----------------------------------------------------------------------------
CELERY_WORKER_POOL=prefork
CELERY_WORKER_CONCURRENCY=6
CELERY_WORKER_MEMORY_LIMIT=20G
CELERY_WORKER_MEMORY_RESERVATION=8G
CELERY_MEMORY_OVERHEAD_GB=2.0

# ----------------------------------------------------------------------------
# Celery Worker Configuration - Gevent (GraphRAG)
# ----------------------------------------------------------------------------
CELERY_GRAPHRAG_CONCURRENCY=200
CELERY_GRAPHRAG_MEMORY_LIMIT=24G
CELERY_GRAPHRAG_MEMORY_RESERVATION=4G

# ----------------------------------------------------------------------------
# GraphRAG Configuration - CRITICAL
# ----------------------------------------------------------------------------
# Leiden clustering configuration - THESE ARE THE KEY VARIABLES
# Target base community size: 15-25 entities (not used directly by pyramid algorithm, kept for reference)
GRAPHRAG_MAX_CLUSTER_SIZE=25
# Resolution: Controls base granularity (higher = more fine-grained base communities)
# 1.0 is recommended for ~75K entities to create ~3000-5000 base communities
GRAPHRAG_LEIDEN_RESOLUTION=1.0
# Base resolution multiplier: Controls how fine-grained the base level is
# Higher values = more base communities (220.0 for ~5500 base communities with 85K entities)
# Formula: base_resolution = LEIDEN_RESOLUTION × BASE_RESOLUTION_MULTIPLIER
# Optimizer result: 220.0 → 5,526 base communities with avg 15.5 entities each
GRAPHRAG_BASE_RESOLUTION_MULTIPLIER=220.0
# Consolidation scaling factor: Controls pyramid steepness (number of levels)
# Lower values = steeper consolidation (fewer levels), higher values = gentler (more levels)
# 0.3 = steep/optimal (6 levels), 0.35 = moderate (6-7 levels), 0.4 = gentle (7-8 levels)
# Optimizer result: 0.30 → 6 levels with proper consolidation
GRAPHRAG_CONSOLIDATION_SCALING_FACTOR=0.30
# Enable pyramid hierarchy algorithm (replaces hierarchical_leiden)
GRAPHRAG_USE_PYRAMID_HIERARCHY=true

# GraphRAG async processing (matches gevent concurrency)
GRAPHRAG_ASYNC_ENABLED=true
GRAPHRAG_ASYNC_BATCH_SIZE=8
GRAPHRAG_ASYNC_MAX_CONCURRENT=200
GRAPHRAG_ASYNC_BATCH_TIMEOUT=9000

# GraphRAG retry/timeout settings (for stability)
GRAPHRAG_REQUEST_TIMEOUT=9000
GRAPHRAG_MAX_RETRIES=200
GRAPHRAG_MAX_RETRY_WAIT=300

# ----------------------------------------------------------------------------
# Vector RAG Configuration
# ----------------------------------------------------------------------------
RAG_ASYNC_ENABLED=true
RAG_ASYNC_BATCH_SIZE=8
RAG_ASYNC_MAX_CONCURRENT=50
RAG_ASYNC_BATCH_TIMEOUT=9000
RAG_EMBEDDING_BATCH_SIZE=50
RAG_EMBEDDING_FALLBACK_SINGLE=true
RAG_EMBEDDING_RETRY_INDIVIDUAL=true
